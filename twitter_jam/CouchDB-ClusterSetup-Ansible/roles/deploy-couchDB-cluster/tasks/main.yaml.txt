- name: Enable Cluster
  shell: 'curl -X POST -H "Content-Type: application/json" http://grp43admin:password@localhost:xxxx/_cluster_setup -d ''{"action": "enable_cluster", "bind_address":"0.0.0.0", "username": "grp43admin", "password":"password", "port": xxxx, "node_count": "4", "remote_node": "{{ item }}", "remote_current_user": "grp43admin", "remote_current_password": "password", "remote_port":xxxx }'''
  args:
    warn: yes
  loop: "{{ couchDB_cluster_servers }}"

- name: Add Nodes to Cluster
  shell: 'curl -X POST -H "Content-Type: application/json" http://grp43admin:password@localhost:xxxx/_cluster_setup -d ''{"action": "add_node", "host":"{{ item }}", "port": xxxx, "username": "grp43admin", "password":"password"}'''
  args:
    warn: yes
  loop: "{{ couchDB_cluster_servers }}"

- name: Finish cluster Setup
  args:
    warn: yes
  shell: 'curl -X POST -H "Content-Type: application/json" http://grp43admin:password@localhost:xxxx/_cluster_setup -d ''{"action": "finish_cluster"}'''

- name: Verify installation
  args:
    warn: yes
    shell: 'curl "http://grp43admin:password@localhost:xxxx/_cluster_setup" '

- name: Verify connection of nodes
  args:
    warn: yes
    shell:  'curl http:///grp43admin:password@localhost:xxxx/_membership" '

- name: Create Tweets Database 
  args:
    warn: yes
  shell: 'curl -X PUT "http://grp43admin:password@localhost:xxxx/tweets_db?q=8&n=3"'

- name: Create Users Database
  args:
    warn: yes
  shell: 'curl -X PUT "http://grp43admin:password@localhost:xxxx/users_db?q=8&n=3"'

- name: Create CouchDB Views Directory
  file:
    path: /data/couchdbViews
    state: directory

