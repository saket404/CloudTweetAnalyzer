- name: Check connection
  args:
    warn: yes
  shell: 'curl "http://{{ couchdb_user }}:{{ couchdb_password }}@{{ groups["Uno"].0 }}:{{ couchdb_port }}" '
  register: connection_check

- name: Enable Cluster
  shell: 'curl -XPOST "http://{{ couchdb_user }}:{{ couchdb_password }}@{{ groups["Uno"].0 }}:{{ couchdb_port }}/_cluster_setup" --header "Content-Type: application/json" --data "{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\",\"username\": \"{{ couchdb_user }}\", \"password\":\"{{ couchdb_password }}\", \"port\": \"{{ couchdb_port }}\", \"remote_node\": \"{{ ansible_default_ipv4.address }}\", \"node_count\": \"{{ couchdb_node_number }}\", \"remote_current_user\":\"{{ couchdb_user }}\", \"remote_current_password\":\"{{ couchdb_password }}\"}"'
  args:
    warn: yes
  loop: '{{ groups["Play"] }}'
  when: item != groups["Uno"].0

- name: Add Nodes to Cluster
  shell: 'curl -XPOST "http://{{ couchdb_user }}:{{ couchdb_password }}@{{ groups["Uno"].0 }}:{{ couchdb_port }}/_cluster_setup" --header "Content-Type: application/json"  --data "{\"action\": \"add_node\", \"host\":\"{{ ansible_default_ipv4.address }}\", \"port\": \"{{ couchdb_port }}\", \"username\": \"{{ couchdb_user }}\", \"password\":\"{{ couchdb_password }}\"}"'
  args:
    warn: yes
  loop: '{{ groups["Play"] }}'
  when: item != groups["Uno"].0
